{% extends 'home/base.html' %}


{% block content %}
<div class="back__button">
    {% comment %} <button type="button" onclick="history.back()" class="btn">Вернуться</button> {% endcomment %}
    <a href="{% url 'profile' profile_id %}">Вернуться</a>
</div>

<input type="hidden" name="profile_id" value="{{ profile_id }}">
{% if request.user.doctor.role not in rolesNA %}
<div class="center_div">
    <div>
        <h3>Планы посещений пациента</h3>
    </div>
    
    {% if request.user.doctor.role not in rolesR %}
    <div class="outer_div">
        <div class="border_div">
            <form action="" method="POST">
                {% csrf_token %}
                <div class="fields add_form">
                    {% for p in form %}
                    <div class="fields__input">
                        <div class="fields__input__label">
                            <strong>{{ p.label_tag }}</strong>
                        </div>
                        <div class="fields__input__field">
                            {{ p }}
                        </div>
                    </div>
                    {{ p.errors }}
                    {% endfor %}
                    {{ form.errors }}
                </div>
                <div class="submit-btn">
                    <button type="submit" class="btn">Добавить</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    <div class="modification_btns">
        <button type="submit" class="mod_btn btn">Добавить</button>
        <a href="" class="mod_btn btn">Изменить</a>
        <form action="" method="POST">
            {% csrf_token %}
            <input type="hidden" name="delete_id" value="-1">
            <button type="submit" class="mod_btn btn same_btn">Удалить</button>
        </form>
    </div>
    {% if notes %}
    <div class="block__profile__disease border_div reception_page">
        <div class="block__lines">
            <table class="table">
                <thead>
                    <tr>
                        <th>{% if user.patient %}
                            Пациент
                            {% else %}
                            Доктор
                            {% endif %}
                        </th>
                        {% if user.is_superuser %}
                        <th>Пациент</th>
                        {% endif %}
                        <th>Дата</th>
                        <th>Медицинская организация</th>
                        <th>Специальность</th>
                        <th>Номер посещения специалиста</th>
                        <th>Кабинет</th>
                        <th>Посещено</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for note in notes %}
                    <tr class="chooseable">
                        <input type="hidden" name="note.pk" value="{{ note.pk }}">
                        <td>
                            {% if user.patient %}
                                <p>{{ note.patient.get_full_name }}</p>
                            {% else %}
                                <p>{{ note.doctor.get_full_name }}</p>
                            {% endif %}
                        </td>
                        {% if user.is_superuser %}
                        <td><p>{{ note.patient.get_full_name }}</p></td>
                        {% endif %}
                        <td><p class="">{{ note.date_meeting }}</p></td>
                        <td><p>{{ note.get_med_organization_display }}</p></td>
                        <td><p>{{ note.get_specialization_display }}</p></td>
                        <td><p>{{ note.visit_number }}</p></td>
                        <td><p>{{ note.cabinet }}</p></td>
                        <td><p>{% if note.status == True %}Да{% else %}Нет{% endif %}</p></td>
                        <td>
                            <p class="btn same_btn"><a href="{% url 'update-reception' profile_id note.pk %}">Изменить</a></p>
                            <form action="" method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="delete_id" value="{{ note.pk }}">
                                <button type="submit" class="btn same_btn">Удалить</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
        <h3>Посещения не назначены</h3>
    {% endif %}
</div>
<script type="text/javascript">
    var change = document.querySelector('a[class="mod_btn btn"]');
    var delete_id = document.querySelector('input[name="delete_id"]');
    var url = document.URL.split('/').slice(0, 3).join('/') + '/';
    var profile_id = document.querySelector('input[name="profile_id"]').value;
    var choosen = undefined;
    
    var rows = [...document.getElementsByClassName('chooseable')];
    for (let row of rows) {
        row.onclick = (e) => {
            if (choosen !== undefined && choosen !== e.currentTarget) {
                choosen.style = "";
                choosen.selected = "false";
            }
            if (e.currentTarget.selected !== "true") {
                let notepk = e.currentTarget.children[0].value;
                e.currentTarget.style.background = "#ffe55b";
                change.href = url + `account/reception/update/${profile_id}/${notepk}`;
                delete_id.value = notepk;
                e.currentTarget.selected = "true";
                choosen = e.currentTarget
            } else {
                e.currentTarget.style = "";
                change.href = '#';
                delete_id.value = "-1";
                e.currentTarget.selected = "false";
                choosen = undefined;
            }
        };
    }
</script>
{% else %}
    <h2>Доступ к данной странице запрещен</h2>
{% endif %}
{% endblock %}